<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Cargar nuevo anteojo</title>
  <style>
    :root { --bg:#f5f5f5; --fg:#111; --muted:#666; --btn:#222; --btnH:#444; }
    body{font-family:Arial, sans-serif; background:var(--bg); color:var(--fg); padding:18px; max-width:760px; margin:auto}
    h1{font-size:1.4rem; margin:0 0 14px}
    label{display:block; font-weight:600; margin-top:12px}
    input, select, textarea, button{ width:100%; padding:10px; margin-top:6px; box-sizing:border-box; font-size:16px }
    textarea{min-height:70px; resize:vertical}
    button{background:var(--btn); color:#fff; border:0; cursor:pointer; border-radius:6px}
    button:hover{background:var(--btnH)}
    small.hint{color:var(--muted)}
    #mensaje-flotante{ position:sticky; top:0; padding:10px 12px; margin-bottom:10px; background:#fff; border:1px solid #ddd; border-radius:6px; font-weight:600 }
    .row-2{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    @media (max-width:560px){ .row-2{grid-template-columns:1fr} }
  </style>
</head>
<body>

  <div id="mensaje-flotante">Listo para cargar üëì</div>

  <h1>Cargar nuevo anteojo</h1>

  <form id="form-anteojo" onsubmit="event.preventDefault(); guardar();">
    <label for="n_anteojo">N¬∞ anteojo</label>
    <input id="n_anteojo" name="n_anteojo" type="text" autocomplete="off" />

    <label for="fabrica">F√°brica</label>
    <input id="fabrica" name="fabrica" type="text" autocomplete="off" />

    <label for="marca">Marca</label>
    <input id="marca" name="marca" type="text" autocomplete="off" />

    <label for="modelo">Modelo</label>
    <input id="modelo" name="modelo" type="text" autocomplete="off" />

    <label for="codigo_color">C√≥digo color</label>
    <input id="codigo_color" name="codigo_color" type="text" autocomplete="off" />

    <div class="row-2">
      <div>
        <label for="color_armazon">Color armaz√≥n</label>
        <input id="color_armazon" name="color_armazon" type="text" autocomplete="off" />
      </div>
      <div>
        <label for="calibre">Calibre</label>
        <input id="calibre" name="calibre" type="text" autocomplete="off" />
      </div>
    </div>

    <label for="color_cristal">Color cristal</label>
    <input id="color_cristal" name="color_cristal" type="text" autocomplete="off" />

    <div class="row-2">
      <div>
        <label for="familia">Familia</label>
        <select id="familia" name="familia">
          <option value="">-- Seleccionar --</option>
          <option value="SOL">SOL</option>
          <option value="RECETA">RECETA</option>
        </select>
        <small class="hint">SOL ¬∑ RECETA</small>
      </div>
      <div>
        <label for="costo">Costo</label>
        <input id="costo" name="costo" type="number" step="0.01" inputmode="decimal" />
      </div>
    </div>

    <label>
      <input type="checkbox" id="tengo_precio" />
      Ingres√© precio p√∫blico (no tengo costo)
    </label>

    <label for="precio">Precio p√∫blico (se calcula en planilla)</label>
    <input id="precio" name="precio" type="number" step="0.01" inputmode="decimal" readonly />
    <small class="hint">Si tild√°s la casilla, pod√©s escribir un precio; el sistema infiere el costo.</small>

    <label for="codigo_barras">C√≥digo de barras</label>
    <input id="codigo_barras" name="codigo_barras" type="text" autocomplete="off" />

    <label for="observaciones">Observaciones</label>
    <textarea id="observaciones" name="observaciones" placeholder="Notas, color especial, etc. (Shift+Enter para salto de l√≠nea)"></textarea>

    <button id="btn-guardar" type="submit">Guardar</button>
    <small class="hint">Tip: tambi√©n pod√©s <b>apretar Enter</b> para guardar.</small>
  </form>

<script>
/* ====== CONFIG ====== */
/* Usa la guardada en localStorage si existe; si no, usa esta por defecto */
const API = (localStorage.getItem('OC_API') || 'https://script.google.com/macros/s/AKfycbxVj1eryyemrFtnRkery0nm5cpWgUd0WxEuCsGsAg2V7ra8VYg3-_dh-3ljXb-bVVeK1g/exec').trim();

/* ====== HELPERS ====== */
const $ = s => document.querySelector(s);
const byId = id => document.getElementById(id);

function msg(txt, ok=true){
  const box = byId('mensaje-flotante');
  box.textContent = txt;
  box.style.color = ok ? '#111' : '#b00020';
}

function toNumber(v){
  const n = parseFloat((v??'').toString().replace(',','.'));
  return isNaN(n) ? '' : +n.toFixed(2);
}
function factorFamilia(f){ const F=(f||'').toUpperCase(); if(F==='RECETA')return 3.63; if(F==='SOL')return 2.42; return null; }

/* ====== PRECIO <-> COSTO ====== */
function recalcular(){
  const tengo = byId('tengo_precio').checked;
  const fam   = byId('familia').value;
  const k     = factorFamilia(fam);

  byId('precio').readOnly = !tengo;
  byId('costo').readOnly  =  tengo;

  const costo  = toNumber(byId('costo').value);
  const precio = toNumber(byId('precio').value);
  if (!k) return;

  if (tengo) {
    if (precio !== '') byId('costo').value = (precio / k).toFixed(2);
  } else {
    if (costo  !== '') byId('precio').value = (costo  * k).toFixed(2);
  }
}

/* ====== API: Pr√≥ximo n√∫mero ====== */
async function cargarNumeroSiguiente(){
  try{
    const r = await fetch(API + '?action=nextNumero', {cache:'no-store'});
    const txt = await r.text();
    let js;
    try { js = JSON.parse(txt); } catch { js = { ok:false, error: txt }; }
    if (js.ok) {
      byId('n_anteojo').value = js.numero;
      msg('Listo para cargar üëì');
    } else {
      msg(js.error || 'No pude obtener el n√∫mero', false);
    }
  }catch(e){
    console.error(e);
    msg('Error de red obteniendo n√∫mero', false);
  }
}

/* ====== API: Guardar ====== */
async function guardar(){
  const payload = {
    n_anteojo      : byId('n_anteojo').value.trim(),   // el backend igual usa max+1
    fabrica        : byId('fabrica').value.trim(),
    marca          : byId('marca').value.trim(),
    modelo         : byId('modelo').value.trim(),
    codigo_color   : byId('codigo_color').value.trim(),
    color_armazon  : byId('color_armazon').value.trim(),
    calibre        : byId('calibre').value.trim(),
    color_cristal  : byId('color_cristal').value.trim(),
    familia        : byId('familia').value.trim(),
    costo          : byId('costo').value,
    tengo_precio   : byId('tengo_precio').checked,
    precio         : byId('precio').value,
    codigo_barras  : byId('codigo_barras').value.trim(),
    observaciones  : byId('observaciones').value.trim(),
  };

  if (!payload.familia) { msg('Eleg√≠ una Familia (SOL / RECETA)', false); byId('familia').focus(); return; }

  // Guardar preferencias √∫tiles
  localStorage.setItem('OC_PREF_MARCA', payload.marca || '');
  localStorage.setItem('OC_PREF_FAMILIA', payload.familia || '');

  byId('btn-guardar').disabled = true; msg('Guardando‚Ä¶');
  try{
    const r = await fetch(API + '?action=guardar', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    const js = await r.json();
    if (js.ok){
      msg(`Guardado ‚úî N¬∞ ${js.numero}`);
      // limpiar campos ‚Äúde detalle‚Äù
      ['modelo','codigo_color','color_armazon','calibre','color_cristal','costo','precio','codigo_barras','observaciones'].forEach(id=>byId(id).value='');
      byId('tengo_precio').checked = false;
      await cargarNumeroSiguiente();
      byId('modelo').focus();
    } else {
      msg(js.error || 'No se pudo guardar', false);
    }
  }catch(e){
    console.error(e);
    msg('Error de red al guardar', false);
  }finally{
    byId('btn-guardar').disabled = false;
  }
}

/* ====== INIT ====== */
function init(){
  // Prefills
  const prefMarca   = localStorage.getItem('OC_PREF_MARCA') || '';
  const prefFamilia = localStorage.getItem('OC_PREF_FAMILIA') || '';
  if (prefMarca) byId('marca').value = prefMarca;
  if (prefFamilia) byId('familia').value = prefFamilia;

  // Listeners
  byId('tengo_precio').addEventListener('change',recalcular);
  byId('familia').addEventListener('change',recalcular);
  byId('costo').addEventListener('input',recalcular);
  byId('precio').addEventListener('input',recalcular);

  // Enter para guardar
  byId('form-anteojo').addEventListener('keydown', (e)=>{
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); guardar(); }
  });

  cargarNumeroSiguiente();
  byId('marca').focus();
}
window.addEventListener('DOMContentLoaded', init);
</script>

</body>
</html>
